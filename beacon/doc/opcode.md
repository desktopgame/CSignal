# オペコード
`beacon VM` で 使用されるオペコードの詳細です。  
まだ実際のソースコードと対応していません。

## 用語
### スタック
計算途中の値を格納しておく領域

### シンボルテーブル
ローカル変数を格納しておく領域

### オペランド
実行するオペコードに引数として与えられる値

### 定数プール
リテラルをソースとして生成された`オブジェクト`を格納するテーブル

### フレーム
スタック、シンボルテーブル、定数プール、バイトコード、子フレームを持つ構造体

### タイプテーブル
あらゆる型をフラットに格納する配列です。

### 関数テーブルポインター
全てのオブジェクトが持っている`関数の一覧`へのポインタ  
vptrと呼称する。

### フィールドテーブル
全てのオブジェクトが持っている`フィールド一覧`のこと

### 擬変数
- `$n`を`スタックから取り出したn番目の値`として表現します。
- `&n`を`バイトコードから取り出したn番目のオペランド`として表現します。

### PC
現在実行中のインストラクションの位置

## 定数
| 名前 | オペランド | スタック | 意味 |
|:---|:---|:---|:---|
|iconst |int(1) |void -> int    |オペランドを添字として定数プールから整数値をプッシュする|
|dconst |int(1) |void -> double |オペランドを添字として定数プールから実数値をプッシュする|
|cconst |int(1) |void -> char   |オペランドを添字として定数プールから文字値をプッシュする|
|sconst |int(1) |void -> string |オペランドを添字として定数プールから文字列値をプッシュする|
|true   |int(1) |void -> bool   |true値をプッシュする|
|false  |int(1) |void -> bool   |false値をプッシュする|
|null   |void   |void -> object |null値をプッシュする|

## 算術演算
| 名前 | オペランド | スタック | 意味 |
|:---|:---|:---|:---|
|iadd |void |int, int -> int |$1 + $2 の結果をプッシュする|
|isub |void |int, int -> int |$1 - $2 の結果をプッシュする|
|imul |void |int, int -> int |$1 * $2 の結果をプッシュする|
|idiv |void |int, int -> int |$1 / $2 の結果をプッシュする|
|imod |void |int, int -> int |$1 % $2 の結果をプッシュする|
|ineg |void |int -> int |-$1 の結果をプッシュする|
|dadd |void |double, double -> double |$1 + $2 の結果をプッシュする|
|dsub |void |double, double -> double |$1 - $2 の結果をプッシュする|
|dmul |void |double, double -> double |$1 * $2 の結果をプッシュする|
|ddiv |void |double, double -> double |$1 / $2 の結果をプッシュする|
|dmod |void |double, double -> double |$1 % $2 の結果をプッシュする|
|dneg |void |double -> double |-$1 の結果をプッシュする|

## 論理演算
| 名前 | オペランド | スタック | 意味 |
|:---|:---|:---|:---|
|ishl |void |int, int -> int |$1 << $2 の結果をプッシュする|
|ishr |void |int, int -> int |$1 >> $2 の結果をプッシュする|
|ior |void |int, int -> int |$1 \| $2 の結果をプッシュする|
|iand |void |int, int -> int |$1 & $2 の結果をプッシュする|
|ixor |void |int, int -> int |$1 ^ $2 の結果をプッシュする|
|irev |void |int -> int |~$1 の結果をプッシュする|

## 比較演算
| 名前 | オペランド | スタック | 意味 |
|:---|:---|:---|:---|
|ieq |void |int, int -> bool |$1 == $2 の結果をプッシュする|
|igt |void |int, int -> bool |$1 > $2 の結果をプッシュする|
|ige |void |int, int -> bool |$1 >= $2 の結果をプッシュする|
|ilt |void |int, int -> bool |$1 < $2 の結果をプッシュする|
|ile |void |int, int -> bool |$1 <= $2 の結果をプッシュする|
|deq |void |double, double -> bool |$1 == $2 の結果をプッシュする|
|dgt |void |double, double -> bool |$1 > $2 の結果をプッシュする|
|dge |void |double, double -> bool |$1 >= $2 の結果をプッシュする|
|dlt |void |double, double -> bool |$1 < $2 の結果をプッシュする|
|dle |void |double, double -> bool |$1 <= $2 の結果をプッシュする|


## シンボルテーブル
| 名前 | オペランド | スタック | 意味 |
|:---|:---|:---|:---|
|put_local  |int(1) |object -> void |シンボルテーブルの&1番目に$1をセットします|
|get_local  |int(1) |void -> object |シンボルテーブルの&1番目をプッシュします。|

## フィールド
| 名前 | オペランド | スタック | 意味 |
|:---|:---|:---|:---|
|put_field  |int(1) |object, object -> void |$1.フィールドテーブルの&1番目を$2で上書きします。|
|get_field  |int(1) |object -> object |$1.フィールドテーブルの&1番目をプッシュします。|
|put_static |int(2) |object -> void |タイプテーブルから&1番目の型を取得し、その&2番目のフィールドを$1で上書きする。|
|get_static |int(2) |void -> object |タイプテーブルから&1番目の型を取得し、その&2番目のフィールドをプッシュする。|


## 関数呼び出し

### privateな関数呼び出し
| 名前 | オペランド | スタック | 意味 |
|:---|:---|:---|:---|
|invokespecial |int(1) |... -> object   |...|
````
$1.vptr の &1番目のメソッドを取得する
新しいフレーム(nfr)を作成する
現在のフレームからメソッドの引数の数だけポップする
nfrのスタックにポップしたオブジェクト全てをプッシュする
nfrのスタックに$1をプッシュする
nfrでメソッドを実行する
````

### 仮想関数の呼び出し
| 名前 | オペランド | スタック | 意味 |
|:---|:---|:---|:---|
|invokevirtual |int(1) |... -> object   |...|
````
$1.vptr の &1番目のメソッドを取得する
新しいフレーム(nfr)を作成する
現在のフレームからメソッドの引数の数だけポップする
nfrのスタックにポップしたオブジェクト全てをプッシュする
nfrのスタックに$1をプッシュする
nfrでメソッドを実行する
````

### 静的メソッドの呼び出し
| 名前 | オペランド | スタック | 意味 |
|:---|:---|:---|:---|
|invokestatic  |int(2) |... -> object   |...|
````
タイプテーブルの&1番目の型を取得する
型.vtの&2番目のメソッドを取得する
新しいフレーム(nfr)を作成する
現在のフレームからメソッドの引数の数だけポップする
nfrのスタックにポップしたオブジェクト全てをプッシュする
nfrでメソッドを実行する
````

### インターフェイスに定義されたメソッドの呼び出し
| 名前 | オペランド | スタック | 意味 |
|:---|:---|:---|:---|
|invokeinterface |int(2) |... -> object  |...|
````
$1のオブジェクトから&1のインターフェイスを検索する
オブジェクトの中のインターフェイスのインデックスを取得する
新しいフレーム(nfr)を作成する
現在のフレームからメソッドの引数の数だけポップする
nfrのスタックにポップしたオブジェクト全てをプッシュする
nfrでメソッドを実行する
````

### 関数からの脱出
| 名前 | オペランド | スタック | 意味 |
|:---|:---|:---|:---|
|return |void |void -> void  |...|
````
PCをバイトコードの長さで上書きします
````

## ジャンプ
| 名前 | オペランド | スタック | 意味 |
|:---|:---|:---|:---|
|jmp            |int(1) |void -> void   |PCを&1で上書きします|
|jmp_if_true    |int(1) |bool -> void   |$1が true なら PCを &1 で上書きします。|
|jmp_if_false   |int(1) |bool -> void   |$1が false なら PCを &1 で上書きします。|
|nop            |void   |void -> void   |何もしません|
